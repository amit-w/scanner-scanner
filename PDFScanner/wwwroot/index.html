<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hello Button</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            display: flex;
            height: 100vh;
            margin: 0;
        }

        main {
            margin: auto;
            text-align: center;
        }

        button {
            padding: 0.6rem 1rem;
            font-size: 1rem;
            cursor: pointer;
        }

        cropper-canvas {
            margin-top: 10px;
            margin-bottom: 10px;
            margin-left: 10px;
            margin-right: 10px;
        }

        #status {
            margin-top: 0.75rem;
            color: #555;
            font-size: 0.9rem;
        }

        .hidden {
            display: none;
        }

        #spinner {
            margin-top: 1rem;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <script src="https://unpkg.com/cropperjs@2.1.0/dist/cropper.min.js"></script>
    <main>
        <cropper-canvas id="cropper-canvas" background class="hidden">
            <cropper-image id="cropper-image"></cropper-image>
            <cropper-shade id="shade"></cropper-shade>
            <cropper-selection id="selection" initial-coverage="1.0" resizable outlined>
                <cropper-handle action="n-resize"></cropper-handle>
                <cropper-handle action="e-resize"></cropper-handle>
                <cropper-handle action="s-resize"></cropper-handle>
                <cropper-handle action="w-resize"></cropper-handle>
                <cropper-handle action="ne-resize"></cropper-handle>
                <cropper-handle action="nw-resize"></cropper-handle>
                <cropper-handle action="se-resize"></cropper-handle>
                <cropper-handle action="sw-resize"></cropper-handle>
            </cropper-selection>
        </cropper-canvas>
        <div id="spinner" class="hidden"></div>
        <p></p>
        <div style="border-width:2px;border-color:black;border-style:solid">
            <button id="scan1" class="fakeScan">Scan (1)</button>
            <button id="scan2" class="fakeScan">Scan (2)</button>
            <button id="intel" class="fakeScan">Intel</button>
            <button id="lenovo" class="fakeScan">Lenovo</button>
            <button id="rice" class="fakeScan">Rice</button>
        </div>
        <button id="scanBtn">Scan</button>
        <button id="finishBtn">Finish</button>
        <div id="status"></div>
    </main>
    <script>
        var pages = [];

        const cropperImage = document.getElementById('cropper-image');
        const shade = document.getElementById('shade');
        const scanBtn = document.getElementById('scanBtn');
        const finishBtn = document.getElementById('finishBtn');
        const status = document.getElementById('status');
        const spinner = document.getElementById('spinner');
        const cropperCanvas = document.getElementById('cropper-canvas');
        const cropperSelection = document.getElementById('selection');
        cropperSelection.addEventListener('change', function (event) {
            shade.hidden = false;
            shade.$change(event.detail.x, event.detail.y, event.detail.width, event.detail.height);
        });

        // Monkey-patching hack to enable scrolling over the image
        cropperCanvas.removeEventListener('wheel', cropperCanvas.$onWheel, { capture: true });
        cropperCanvas.$onWheel = null;


        function init_cropper(image, width, height) {
            console.log(`init_cropper: width:height = ${width}:${height}`);
            shade.$change(0, 0, width, height);
            cropperSelection.$change(0, 0, width, height);
            cropperImage.src = image;

            cropperCanvas.classList.remove('hidden');
            cropperCanvas.style.width = `${width}px`;
            cropperCanvas.style.height = `${height}px`;
        }


        function handleImage(data) {
            const url = URL.createObjectURL(data);

            var lImg = new Image();
            lImg.onload = () => {
                const margin = 20;
                const maxWidth = document.documentElement.clientWidth - margin;
                console.log("maxWidth: ", maxWidth);
                const scale = Math.min(1, maxWidth / lImg.naturalWidth);
                const width = lImg.naturalWidth * scale;
                const height = lImg.naturalWidth * scale;
                console.log('handleImage::onload: width:', width, 'height:', height);

                init_cropper(url, width, height);
            }
            lImg.src = url;
        }

        function addListener(btn) {
            btn.addEventListener('click', async () => {
                try {
                    const res = await fetch('/fakeScan', { method: 'POST', headers: { "Content-Type": "application/json" }, body: JSON.stringify({ fileName: btn.id }) });
                    if (!res.ok) {
                        throw new Error('Request failed: ' + res.status);
                    }

                    const data = await res.blob();
                    handleImage(data);
                } catch (err) {
                    status.textContent = 'Error: ' + err.message;
                }

            })

        }

        for (btn of document.getElementsByClassName('fakeScan')) {
            addListener(btn);
        }

        scanBtn.addEventListener('click', async () => {
            spinner.classList.remove('hidden');
            status.textContent = 'Waiting for scan...';

            try {
                const res = await fetch('/scan', { method: 'POST' });
                if (!res.ok) {
                    throw new Error('Request failed: ' + res.status);
                }

                const data = await res.blob();
                handleImage(data);
            } catch (err) {
                status.textContent = 'Error: ' + err.message;
            } finally {
                spinner.classList.add('hidden');
                status.textContent = null;
            }
        });
        finishBtn.addEventListener('click', async () => {
            try {
                const formData = new FormData();

                const name = prompt('Enter file name:');
                if (!name) {
                    status.textContent = "No name entered.";
                    return;
                }

                formData.set('filename', name);
                console.log("pages: ", pages.length);

                for (blob of pages) {
                    formData.append('file', blob, 'cropped.bmp');
                }

                const res = await fetch('/finish2', { method: 'POST', body: formData });
                if (!res.ok) throw new Error('Upload failed: ' + res.status);
            } catch (err) {
                status.textContent = 'Error: ' + err.message;
                throw err;
            }
        });
    </script>
</body>

</html>